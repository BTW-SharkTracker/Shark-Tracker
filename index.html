<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Beneath the Waves</title>
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.css" rel="stylesheet" />
	<link rel="stylesheet"
		  href="https://fonts.googleapis.com/css?family=Montserrat">
	<link rel="stylesheet" href="styles.css">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

</head>

<body>

	<div id='map'></div>
	<div id='console'>
		<h1>Beneath the Waves</h1>
	</div>

	<nav id="filter-group" class="filter-group"></nav>
	<nav id="filter-group2" class="filter-group2"></nav>
	<div id="speciesDiv">
	<div id="slider"></div></div>
	<div id="chart"></div>

		<!--table for data of brushed elements-->
		<div id="table">
				<table>
						<tr>
								<th>State</th>
								<th>Income</th>
								<th>High School Graduation</th>
						</tr>
				</table>
		</div>
</body>

<script type="text/javascript">

	mapboxgl.accessToken = 'pk.eyJ1IjoiYWczNzEzYSIsImEiOiJjazd1aG04MnUxYjU2M25rNWh5Nng2NmN6In0.4HUpNtdZx3kHM-dY4YY3GQ';
	var filterGroup = document.getElementById('filter-group');
	var filterGroup2 = document.getElementById('filter-group2');
	var map = new mapboxgl.Map({
	container: 'map',
	style: 'mapbox://styles/mapbox/dark-v10',
	center: [-55.101826, 30.855898],
	zoom: 3,
	minZoom: 3,
	maxZoom: 6
	});



	// Popup that says loading...
	var loading = new mapboxgl.Popup({ closeOnClick: false })
		.setLngLat([-55.101826, 30.855898])
		.setHTML('<p>Loading...</p><div class="loader"></div>')
		.addTo(map);

	// Create GeoJSON lines
	var lines = {
		"type":"FeatureCollection",
		"features": []
	};

	var canvas = map.getCanvasContainer();

		map.on('load', function() {
			Promise.all([
				d3.csv('BTW_Tracks_July31_19.csv'),
				d3.csv('Metadata_Sharks_ToJuly31_19.csv'),
				d3.json('oceans.json')])
			.then(ready);

			function ready(data) {
				var trackIterator;
				// Where we are in the new array
				var trackPos;

				var nodes1=data[0];
				var meta1=data[1];
				var oceans1=data[2];
				var nodeFeatures = [];
				var metaFC=[];

				meta1.forEach(function(d){
						metaFC.push(d);
				});
				//console.log(metaFC);

				nodes1.forEach(function(d){
						metaFC.forEach(function(e){
							if (e["Shark ID"]==d["Shark ID"]){
								sp=e["Species Name"];
								commn=e["Commn Name"];
								n=e["Name"];
								tt=e["TagType"];
								td=e["TagDay"];
								ty=e["TagYear"];
								tm=e["TagMonth"];
								t=e["Total Length"];
								s=e["Sex"];
								m=e["Maturity"];
								tc=e["Track Color"];
								a=e["Active?"];
								return sp,commn,n,tt,td,ty,tm,t,s,m,tc,a
							}
						});
						var parts =d["Date"].split('/');
						// Please pay attention to the month (parts[1]); JavaScript counts months from 0:
						// January - 0, February - 1, etc.
						var yearParts =parts[2].split(' ');
			      var month=parts[0]-1;
			      var day=parts[1];
			      var year=yearParts[0];
			      var time=yearParts[1];
						//console.log(parts[0]);
						d.day=day;
						d.month=month;
						d.year=year;
						d.LatLng = [+d.Lat, +d.Lon];
						d.Species=sp;
						d.CommonName=commn;
						d.Name=n;
						d.TagType=tt;
						d.TagDay=td;
						d.TagMonth=tm;
						d.Length=t;
						d.Sex=s;
						d.Maturity=m;
						d.TrackColor=tc;
						d.ActiveStatus=a;

						if (d.Class>=0){
							nodeFeatures.push(turf.point([+d.Lon, +d.Lat], d));
						}
						else if (d.CommonName=='Tiger') {
							nodeFeatures.push(turf.point([+d.Lon, +d.Lat], d));
						}

				});

				nodeFeatures = turf.featureCollection(nodeFeatures);

				var ptsWithin = turf.pointsWithinPolygon(nodeFeatures, oceans1);
				// console.log(ptsWithin);


				for (trackIterator = 0; trackIterator < ptsWithin.features.length; trackIterator++) {
					if (trackIterator == 0) {
						trackPos = 0;
					} else {
							if (ptsWithin.features[trackIterator].properties["Shark ID"] == ptsWithin.features[trackIterator-1].properties["Shark ID"] ) {
									lines.features.push({ "type": "Feature","geometry": {"type": "LineString","coordinates": []},"properties": {"Shark ID": null, "Date": null, "Date2": null, "Species Name": null, "month": null, "year": null}});
										lines.features[trackPos].geometry.coordinates.push(ptsWithin.features[trackIterator].geometry.coordinates);
										lines.features[trackPos].geometry.coordinates.push(ptsWithin.features[trackIterator-1].geometry.coordinates);
										lines.features[trackPos].properties["Shark ID"] = ptsWithin.features[trackIterator].properties["Shark ID"];
										lines.features[trackPos].properties["Species"] = ptsWithin.features[trackIterator].properties["Species"];
										lines.features[trackPos].properties["month"] = ptsWithin.features[trackIterator].properties["month"];
										lines.features[trackPos].properties["year"] = ptsWithin.features[trackIterator].properties["year"];
										lines.features[trackPos].properties.Date = ptsWithin.features[trackIterator-1].properties.Date;
										lines.features[trackPos].properties.Date2 = ptsWithin.features[trackIterator].properties.Date;
										trackPos++;
						}
					}
				}

				// Close the loading popup
				doneLoading();
				function doneLoading() {
					loading.remove();
				}

					map.addSource('Sharks', {
							'type':'geojson',
							'data': ptsWithin
					});

					map.addSource('10m-bathymetry-81bsvj', {
					type: 'vector',
					url: 'mapbox://mapbox.9tm8dx88'
					});

					map.addLayer(
					{
						'id': '10m-bathymetry-81bsvj',
						'type': 'fill',
						'source': '10m-bathymetry-81bsvj',
						'source-layer': '10m-bathymetry-81bsvj',
						'layout': {},
						'paint': {
						'fill-outline-color': 'hsla(337, 82%, 62%, 0)',
						'fill-color': [
							'interpolate',
							['cubic-bezier', 0, 0.5, 1, 0.5],
							['get', 'DEPTH'],
							200,
								'#002c47',
								9000,
								'#00131f'
							]
						}
					},
					'land-structure-polygon'
					);

					map.addSource('Oceans', {
						'type': 'geojson',
						'data': 'oceans.json'
					});
					map.addSource('lines', {
							type: 'geojson',
							data: lines
						});

					map.addLayer({
						'id': 'pgLines',
						'type': 'line',
						'source': 'lines',
						'layout': {
							'line-join': 'round',
							'line-cap': 'round'
						},
						'paint': {
							'line-color':"#003165",
							'line-width': 1,
						},
						"filter": ["==", "Species","Prionace glauca"]
					});

					map.addLayer({
						'id': 'pg',
						'type': 'circle',
						'source': 'Sharks',
						'paint': {
							'circle-radius': [
							'interpolate', ['linear'], ['zoom'],
								3, 2,
								6, 4,
							],
							'circle-color': '#1f77b4'},
							//filter out points based on data quality
								"filter":["all", ["==","Species","Prionace glauca"],
									["any",
									["==","Class","0"],
									["==","Class","1"],
									["==","Class","2"],
									["==","Class","3"]]]
					});

					map.addLayer({
						'id': 'ioxLines',
						'type': 'line',
						'source': 'lines',
						'layout': {
							'line-join': 'round',
							'line-cap': 'round'
						},
						'paint': {
							'line-color':"#9F3100",
							'line-width': 1,
						},
						"filter": ["==", "Species","Isurus oxyrinchus"]
					});

						map.addLayer({
							'id': 'iox',
							'type': 'circle',
							'source': 'Sharks',
							'paint': {
								'circle-radius': [
							'interpolate', ['linear'], ['zoom'],
								3, 2,
								6, 4,
							],
								'circle-color': '#ff7f0e'},
								//filter out points based on data quality
									"filter":["all", ["==","Species","Isurus oxyrinchus"],
										["any",
										["==","Class","0"],
										["==","Class","1"],
										["==","Class","2"],
										["==","Class","3"]]]
						});

						map.addLayer({
						'id': 'lnLines',
						'type': 'line',
						'source': 'lines',
						'layout': {
							'line-join': 'round',
							'line-cap': 'round'
						},
						'paint': {
							'line-color':"#005200",
							'line-width': 1,
						},
						"filter": ["==", "Species","Lamna nasus"]
					});
						map.addLayer({
							'id': 'ln',
							'type': 'circle',
							'source': 'Sharks',
							'paint': {
								'circle-radius': [
							'interpolate', ['linear'], ['zoom'],
								3, 2,
								6, 4,
							],
								'circle-color': '#2ca02c'},
								//filter out points based on data quality
									"filter":["all", ["==","Species","Lamna nasus"],
										["any",
										["==","Class","0"],
										["==","Class","1"],
										["==","Class","2"],
										["==","Class","3"]]]
						});

						map.addLayer({
						'id': 'gcLines',
						'type': 'line',
						'source': 'lines',
						'layout': {
							'line-join': 'round',
							'line-cap': 'round'
						},
						'paint': {
							'line-color':"#780000",
							'line-width': 1,
						},
						"filter": ["==", "Species","Galeocerdo cuvier"]
					});
						map.addLayer({
							'id': 'gc',
							'type': 'circle',
							'source': 'Sharks',
							'paint': {
								'circle-radius': [
							'interpolate', ['linear'], ['zoom'],
								3, 2,
								6, 4,
							],
								'circle-color': '#d62728'},
								//filter out points based on data quality
									"filter":["all", ["==","Species","Galeocerdo cuvier"],
										["any",
										["==","Class","A"],
										["==","Class","B"],
										["==","Class","0"],
										["==","Class","1"],
										["==","Class","2"],
										["==","Class","3"]]]
						});

						map.addLayer({
						'id': 'coLines',
						'type': 'line',
						'source': 'lines',
						'layout': {
							'line-join': 'round',
							'line-cap': 'round'
						},
						'paint': {
							'line-color':"#441E6D",
							'line-width': 1,
						},
						"filter": ["==", "Species","Carcharhinus obscurus"]
					});
						map.addLayer({
							'id': 'co',
							'type': 'circle',
							'source': 'Sharks',
							'paint': {
								'circle-radius': [
							'interpolate', ['linear'], ['zoom'],
								3, 2,
								6, 4,
							],
								'circle-color': '#9467bd'},
								//filter out points based on data quality
									"filter":["all", ["==","Species","Carcharhinus obscurus"],
										["any",
										["==","Class","0"],
										["==","Class","1"],
										["==","Class","2"],
										["==","Class","3"]]]
						});



						var inputGC = document.createElement('input');
							inputGC.type = 'checkbox';
							inputGC.id = "gc";
							inputGC.checked = true;
							filterGroup.appendChild(inputGC);

							var labelGC = document.createElement('label');
							labelGC.setAttribute('for', "gc");
							labelGC.textContent = "Galeocerdo cuvier";
							filterGroup.appendChild(labelGC);

							// When the checkbox changes, update the visibility of the layer.
							inputGC.addEventListener('change', function(e) {
							map.setLayoutProperty(
							"gc",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							map.setLayoutProperty(
							"gcLines",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							});

						var inputLN = document.createElement('input');
							inputLN.type = 'checkbox';
							inputLN.id = "ln";
							inputLN.checked = true;
							filterGroup.appendChild(inputLN);

							var labelLN = document.createElement('label');
							labelLN.setAttribute('for', "ln");
							labelLN.textContent = "Lamna nasus";
							filterGroup.appendChild(labelLN);

							// When the checkbox changes, update the visibility of the layer.
							inputLN.addEventListener('change', function(e) {
							map.setLayoutProperty(
							"ln",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							map.setLayoutProperty(
							"lnLines",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							});

						var inputIOX = document.createElement('input');
							inputIOX.type = 'checkbox';
							inputIOX.id = "iox";
							inputIOX.checked = true;
							filterGroup.appendChild(inputIOX);

							var labelIOX = document.createElement('label');
							labelIOX.setAttribute('for', "iox");
							labelIOX.textContent = "Isurus oxyrinchus";
							filterGroup.appendChild(labelIOX);

							// When the checkbox changes, update the visibility of the layer.
							inputIOX.addEventListener('change', function(e) {
							map.setLayoutProperty(
							"iox",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							map.setLayoutProperty(
							"ioxLines",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							});

						var inputCO = document.createElement('input');
							inputCO.type = 'checkbox';
							inputCO.id = "co";
							inputCO.checked = true;
							filterGroup.appendChild(inputCO);

							var labelCO = document.createElement('label');
							labelCO.setAttribute('for', "co");
							labelCO.textContent = "Carcharhinus obscurus";
							filterGroup.appendChild(labelCO);

							// When the checkbox changes, update the visibility of the layer.
							inputCO.addEventListener('change', function(e) {
							map.setLayoutProperty(
							"co",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							map.setLayoutProperty(
							"coLines",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							});


						var inputpg = document.createElement('input');
							inputpg.type = 'checkbox';
							inputpg.id = "pg";
							inputpg.checked = true;
							filterGroup.appendChild(inputpg);

							var labelpg = document.createElement('label');
							labelpg.setAttribute('for', "pg");
							labelpg.textContent = "Prionace glauca";
							filterGroup.appendChild(labelpg);

							// When the checkbox changes, update the visibility of the layer.
							inputpg.addEventListener('change', function(e) {
							map.setLayoutProperty(
							"pg",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							map.setLayoutProperty(
							"pgLines",
							'visibility',
							e.target.checked ? 'visible' : 'none'
							);
							});


						//generate pop-up when a node is clicked on
						map.on('click', function (e) {
						var bbox = [
							[e.point.x - 10, e.point.y - 10],
							[e.point.x + 10, e.point.y + 10]
						];
						var features = map.queryRenderedFeatures(bbox, { layers: ['pg', 'iox', 'gc', 'co', 'ln'] });

						if (!features.length) {
							return;
						}

						var feature = features[0];
						var popup = new mapboxgl.Popup()
							.setLngLat(feature.geometry.coordinates)
							.setHTML('<h3><p>' +feature.properties['Name']+"</h3> "+"<h4>Common Name:</h4>"+feature.properties['CommonName']+
									"</p><h4>Species: </h4>"+feature.properties['Species']
									+"<br/><h4>Date: </h4>"+feature.properties['Date'])
							.addTo(map);
						});

						// Change mouse pointer when near point
						map.on('mousemove', function (e) {
						var features = map.queryRenderedFeatures(e.point, {layers: ['pg','co','iox','gc','ln']});
						map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
						});



						
						//slider
						var formatDateIntoYear = d3.timeFormat("%Y");
						var formatDate = d3.timeFormat("%b %Y");

						var startDate = new Date("2016-01-01"),
						    endDate = new Date("2017-12-31");

						var margin = {top:0, right:20, bottom:0, left:60},
						    width = 900,
						    height = 200;

						var svg = d3.select("#slider")
						    .append("svg")
						    .attr("width", width + margin.left + margin.right)
						    .attr("height", height);

						var x = d3.scaleTime()
						    .domain([startDate, endDate])
						    .range([0, width])
						    .clamp(true);

						var slider = svg.append("g")
						    .attr("class", "slider")
						    .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

						slider.append("line")
						    .attr("class", "track")
						    .attr("x1", x.range()[0])
						    .attr("x2", x.range()[1])
						  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
						    .attr("class", "track-inset")
						  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
						    .attr("class", "track-overlay")
						    .call(d3.drag()
						        .on("start.interrupt", function() { slider.interrupt(); })
						        .on("start drag", function() { hue(x.invert(d3.event.x)); }));

						slider.insert("g", ".track-overlay")
						    .attr("class", "ticks")
						    .attr("transform", "translate(0," + 18 + ")")
						  .selectAll("text")
						    .data(x.ticks(12))
						    .enter()
						    .append("text")
						    .attr("x", x)

						    .attr("y", 10)
						    .attr("text-anchor", "middle")
						    .text(function(d) { return formatDate(d); });

						var label1 = slider.append("text")
						    .attr("class", "label1")
						    .attr("text-anchor", "middle")
								.attr("color", "white")
						    .text(formatDate(startDate))
						    .attr("transform", "translate(0," + (-25) + ")")

						var handle = slider.insert("circle", ".track-overlay")
						    .attr("class", "handle")
						    .attr("r", 9);
						function getMonth(z){
							if (z=="Jan"){
								return 0
							}
							if (z=="Feb"){
								return 1
							}
							if (z=="Mar"){
								return 2
							}
							if (z=="Apr"){
								return 3
							}
							if (z=="May"){
								return 4
							}
							if (z=="Jun"){
								return 5
							}
							if (z=="Jul"){
								return 6
							}
							if (z=="Aug"){
								return 7
							}
							if (z=="Sep"){
								return 8
							}
							if (z=="Oct"){
								return 9
							}
							if (z=="Nov"){
								return 10
							}
							if (z=="Dec"){
								return 11
							}
						}
						function hue(h) {
							//typeOf h)
							//var parts =h.split(' ');
							dateString=h.toString();
							var parts =dateString.split(' ');
							//console.log(parts[0]);

							var yearParts =parts[2].split(' ');
				      var month=getMonth(parts[1]);
				      var day=parts[2];
				      var year=parts[3];
				      //var time=yearParts[1];

							//console.log(h.toString());
							console.log(month);
							//map.setFilter('gc', ["==","month",month]);
							map.setFilter('gc',["all",["==","month",month], ["==", "Shark ID", "171619"]]);
							map.setFilter('gcLines',["all",["==","month",month], ["==", "Shark ID", "171619"]]);
						  handle.attr("cx", x(h));
							//console.log(handle.attr("cx", x(h)));
						  label1
						    .attr("x", x(h))
						    .text(formatDate(h));
						}


			}
		});
</script>
